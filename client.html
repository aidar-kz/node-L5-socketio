<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/bootstrap/dist/css/bootstrap.min.css" />
    <title>Document</title>
    <style>
      #messages {
        list-style-type: none;
        margin: 0;
        padding: 0;
      }
      #messages > li {
        padding: 0.5rem 1rem;
      }
      #messages > li:nth-child(odd) {
        background: #efefef;
      }
    </style>
  </head>
  <body>
    <ul id="messages"></ul>

    <div id="forms" class="fixed-bottom">
      <form id="nameForm" class="d-flex">
        <input type="text" id="nameInput" class="form-control" placeholder="Введите ваше имя" />
        <button class="btn btn-outline-primary">Готово</button>
      </form>

      <form id="msgForm" class="d-flex">
        <input type="text" id="msgInput" autocomplete="off" class="form-control" />
        <button class="btn btn-success">Отправить</button>
      </form>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      var socket = io({ autoConnect: false });

      var messages = document.getElementById("messages");
      var nameForm = document.getElementById("nameForm");
      var nameInput = document.getElementById("nameInput");
      var msgForm = document.getElementById("msgForm");
      var msgInput = document.getElementById("msgInput");

      msgForm.classList.add("d-none");

      nameForm.addEventListener("submit", function (event) {
        event.preventDefault();
        if (nameInput.value) {
          socket.auth = { username: nameInput.value };
          socket.connect();
          nameForm.classList.add("d-none");
          msgForm.classList.remove("d-none");
        }
      });

      msgForm.addEventListener("submit", function (event) {
        event.preventDefault();
        if (msgInput.value) {
          socket.emit("chat message", msgInput.value);
          msgInput.value = "";
        }
      });

      function addMessage(msg) {
        var li = document.createElement("li");
        li.innerHTML = msg;
        messages.appendChild(li);
        window.scrollTo(0, document.body.scrollHeight);
      }

      /**
       * События сокета
       */

      socket.on("connection", function (username) {
        var msg = `<small><i>Пользователь <b>${username}</b> подключился</i></small>`;
        addMessage(msg);
      });

      socket.on("disconnection", function (username) {
        var msg = `<small><i>Пользователь с <b>${username}</b> отключился</i></small>`;
        addMessage(msg);
      });

      socket.on("chat message", function (msg) {
        addMessage(msg);
      });
    </script>
  </body>
</html>
